{"ast":null,"code":"/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { maybeDocumentMap } from '../model/collections';\nimport { assert } from '../util/assert';\nimport { PersistentListenStream, PersistentWriteStream } from './persistent_stream';\n/**\n * Datastore is a wrapper around the external Google Cloud Datastore grpc API,\n * which provides an interface that is more convenient for the rest of the\n * client SDK architecture to consume.\n */\n\nvar Datastore =\n/** @class */\nfunction () {\n  function Datastore(databaseInfo, queue, connection, credentials, serializer, initialBackoffDelay) {\n    this.databaseInfo = databaseInfo;\n    this.queue = queue;\n    this.connection = connection;\n    this.credentials = credentials;\n    this.serializer = serializer;\n    this.initialBackoffDelay = initialBackoffDelay;\n  }\n\n  Datastore.prototype.newPersistentWriteStream = function () {\n    return new PersistentWriteStream(this.databaseInfo, this.queue, this.connection, this.credentials, this.serializer, this.initialBackoffDelay);\n  };\n\n  Datastore.prototype.newPersistentWatchStream = function () {\n    return new PersistentListenStream(this.databaseInfo, this.queue, this.connection, this.credentials, this.serializer, this.initialBackoffDelay);\n  };\n\n  Datastore.prototype.commit = function (mutations) {\n    var _this = this;\n\n    var params = {\n      database: this.serializer.encodedDatabaseId,\n      writes: mutations.map(function (m) {\n        return _this.serializer.toMutation(m);\n      })\n    };\n    return this.invokeRPC('Commit', params).then(function (response) {\n      return _this.serializer.fromWriteResults(response.writeResults);\n    });\n  };\n\n  Datastore.prototype.lookup = function (keys) {\n    var _this = this;\n\n    var params = {\n      database: this.serializer.encodedDatabaseId,\n      documents: keys.map(function (k) {\n        return _this.serializer.toName(k);\n      })\n    };\n    return this.invokeStreamingRPC('BatchGetDocuments', params).then(function (response) {\n      var docs = maybeDocumentMap();\n      response.forEach(function (proto) {\n        var doc = _this.serializer.fromMaybeDocument(proto);\n\n        docs = docs.insert(doc.key, doc);\n      });\n      var result = [];\n      keys.forEach(function (key) {\n        var doc = docs.get(key);\n        assert(!!doc, 'Missing entity in write response for ' + key);\n        result.push(doc);\n      });\n      return result;\n    });\n  };\n  /** Gets an auth token and invokes the provided RPC. */\n\n\n  Datastore.prototype.invokeRPC = function (rpcName, request) {\n    var _this = this; // TODO(mikelehen): Retry (with backoff) on token failures?\n\n\n    return this.credentials.getToken(\n    /*forceRefresh=*/\n    false).then(function (token) {\n      return _this.connection.invokeRPC(rpcName, request, token);\n    });\n  };\n  /** Gets an auth token and invokes the provided RPC with streamed results. */\n\n\n  Datastore.prototype.invokeStreamingRPC = function (rpcName, request) {\n    var _this = this; // TODO(mikelehen): Retry (with backoff) on token failures?\n\n\n    return this.credentials.getToken(\n    /*forceRefresh=*/\n    false).then(function (token) {\n      return _this.connection.invokeStreamingRPC(rpcName, request, token);\n    });\n  };\n\n  return Datastore;\n}();\n\nexport { Datastore };","map":{"version":3,"sources":["../src/remote/datastore.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as api from '../protos/firestore_proto_api';\nimport { CredentialsProvider } from '../api/credentials';\nimport { DatabaseInfo } from '../core/database_info';\nimport { maybeDocumentMap } from '../model/collections';\nimport { MaybeDocument } from '../model/document';\nimport { DocumentKey } from '../model/document_key';\nimport { Mutation, MutationResult } from '../model/mutation';\nimport { assert } from '../util/assert';\nimport { AsyncQueue } from '../util/async_queue';\n\nimport { Connection } from './connection';\nimport {\n  PersistentListenStream,\n  PersistentWriteStream,\n  WatchStreamListener,\n  WriteStreamListener\n} from './persistent_stream';\nimport { JsonProtoSerializer } from './serializer';\n\n// The generated proto interfaces for these class are missing the database\n// field. So we add it here.\n// TODO(b/36015800): Remove this once the api generator is fixed.\ninterface BatchGetDocumentsRequest extends api.BatchGetDocumentsRequest {\n  database?: string;\n}\ninterface CommitRequest extends api.CommitRequest {\n  database?: string;\n}\n\n/**\n * Datastore is a wrapper around the external Google Cloud Datastore grpc API,\n * which provides an interface that is more convenient for the rest of the\n * client SDK architecture to consume.\n */\nexport class Datastore {\n  constructor(\n    private databaseInfo: DatabaseInfo,\n    private queue: AsyncQueue,\n    private connection: Connection,\n    private credentials: CredentialsProvider,\n    private serializer: JsonProtoSerializer,\n    private initialBackoffDelay?: number\n  ) {}\n\n  public newPersistentWriteStream(): PersistentWriteStream {\n    return new PersistentWriteStream(\n      this.databaseInfo,\n      this.queue,\n      this.connection,\n      this.credentials,\n      this.serializer,\n      this.initialBackoffDelay\n    );\n  }\n\n  public newPersistentWatchStream(): PersistentListenStream {\n    return new PersistentListenStream(\n      this.databaseInfo,\n      this.queue,\n      this.connection,\n      this.credentials,\n      this.serializer,\n      this.initialBackoffDelay\n    );\n  }\n\n  commit(mutations: Mutation[]): Promise<MutationResult[]> {\n    const params: CommitRequest = {\n      database: this.serializer.encodedDatabaseId,\n      writes: mutations.map(m => this.serializer.toMutation(m))\n    };\n    return this.invokeRPC('Commit', params).then(\n      (response: api.CommitResponse) => {\n        return this.serializer.fromWriteResults(response.writeResults);\n      }\n    );\n  }\n\n  lookup(keys: DocumentKey[]): Promise<MaybeDocument[]> {\n    const params: BatchGetDocumentsRequest = {\n      database: this.serializer.encodedDatabaseId,\n      documents: keys.map(k => this.serializer.toName(k))\n    };\n    return this.invokeStreamingRPC('BatchGetDocuments', params).then(\n      (response: api.BatchGetDocumentsResponse[]) => {\n        let docs = maybeDocumentMap();\n        response.forEach(proto => {\n          const doc = this.serializer.fromMaybeDocument(proto);\n          docs = docs.insert(doc.key, doc);\n        });\n        const result: MaybeDocument[] = [];\n        keys.forEach(key => {\n          const doc = docs.get(key);\n          assert(!!doc, 'Missing entity in write response for ' + key);\n          result.push(doc!);\n        });\n        return result;\n      }\n    );\n  }\n\n  /** Gets an auth token and invokes the provided RPC. */\n  private invokeRPC(rpcName: string, request: any): Promise<any> {\n    // TODO(mikelehen): Retry (with backoff) on token failures?\n    return this.credentials.getToken(/*forceRefresh=*/ false).then(token => {\n      return this.connection.invokeRPC(rpcName, request, token);\n    });\n  }\n\n  /** Gets an auth token and invokes the provided RPC with streamed results. */\n  private invokeStreamingRPC(rpcName: string, request: any): Promise<any> {\n    // TODO(mikelehen): Retry (with backoff) on token failures?\n    return this.credentials.getToken(/*forceRefresh=*/ false).then(token => {\n      return this.connection.invokeStreamingRPC(rpcName, request, token);\n    });\n  }\n}\n"]},"metadata":{},"sourceType":"module"}